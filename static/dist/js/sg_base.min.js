var SG={};SG.EMOJI_DOMAIN="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/images/basic";function goTop(){$(window).scroll(function(e){$(window).scrollTop()>100?$("#gotop").fadeIn(500):$("#gotop").fadeOut(500)})}if(SG.Publisher=function(){},SG.Publisher.prototype={publish:function(e,t){var a=$(e).text();$(e).text("稍等").addClass("disabled").attr({title:"稍等",disabled:"disabled"});var o=$(e).parents("form"),n=o.serialize(),r=o.attr("action");$.ajax({type:"post",url:r,data:n,dataType:"json",success:function(e){if(e.ok){if(o.get(0).reset(),void 0!==e.msg?comTip(e.msg):comTip("发布成功！"),void 0!==t)return void t(e.data);setTimeout(function(){var e=o.data("redirect");e&&(window.location.href=e)},1e3)}else comTip(e.error)},complete:function(t,o){$(e).text(a).removeClass("disabled").removeAttr("disabled").attr({title:a})},error:function(t,o,n){$(e).text(a).removeClass("disabled").removeAttr("disabled").attr({title:a}),403==t.status&&comTip("没有修改权限")}})}},SG.replaceSpecialChar=function(e){return e=(e=(e=(e=(e=e.replace(/&#34;/g,'"')).replace(/&#39;/g,"'")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&amp;/g,"&")},SG.markSetting=function(){var e=new marked.Renderer;return e.html=function(e){return-1!=e.indexOf("<script")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<input")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<select")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<textarea")?e.replace(/</g,"&lt;"):e},marked.setOptions({renderer:e,highlight:function(e){return e=SG.replaceSpecialChar(e),hljs.highlightAuto(e).value}}),marked},SG.markSettingNoHightlight=function(){var e=new marked.Renderer;return e.html=function(e){return-1!=e.indexOf("<script")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<input")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<select")?e.replace(/</g,"&lt;"):-1!=e.indexOf("<textarea")?e.replace(/</g,"&lt;"):e},marked.setOptions({renderer:e,highlight:function(e){return e=SG.replaceSpecialChar(e)}}),marked},SG.replaceCodeChar=function(e){return(e=e.replace(/<code class="lang-/g,'<code class="language-')).replace(/<code>.*<\/code>/g,function(e,t,a){return SG.replaceSpecialChar(e)})},SG.preProcess=function(e){return e=e.replace(/&gt;/g,">")},SG.analyzeAt=function(e){var t=[];return String(e).replace(/[^@]*@([^\s@]{4,20})\s*/g,function(e,a){t.push(a)}),t},SG.registerAtEvent=function(e,t,a){if(void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===a&&(a=$("form textarea")),e){var o,n={};a.atwho({at:"@",tpl:"<li data-value='${atwho-at}${username}'><img src='${avatar}' height='20' width='20' /> ${username}</li>",search_key:"username",callbacks:{remote_filter:function(e,t){var a=e,r=$(this);r.data("active")||(r.data("active",!0),"object"==typeof(o=n[a])?t(o):(r.xhr&&r.xhr.abort(),r.xhr=$.getJSON("/at/users",{term:a},function(e){n[a]=e,t(e)})),r.data("active",!1))}}})}t&&a.atwho({at:":",data:window.emojis,tpl:"<li data-value='${key}'><img src='"+SG.EMOJI_DOMAIN+"/${name}.png' height='20' width='20' /> ${name}</li>"})},jQuery(document).ready(function(e){e.timeago.settings.cutoff=864e7,SG.timeago=function(t){return e.timeago(t)},e(".timeago").timeago(),e(".tool-tip").tooltip(),e("#gotop").click(function(t){e("body,html").animate({scrollTop:0},100)}),goTop(),window.comTip=function(t){e("<div>").addClass("comTip").text(t).appendTo("body");var a=setInterval(function(){if(e(".comTip").width()){clearInterval(a);var t=(e(window).width()-e(".comTip").outerWidth())/2,o=(e(window).height()-e(".comTip").outerHeight())/2;o=(o<0?0:o)+e(window).scrollTop(),e(".comTip").css({left:t,top:o}).fadeIn(500),setTimeout(function(){e(".comTip").fadeOut(1e3)},1800),setTimeout(function(){e(".comTip").remove()},3e3)}},500)},window.openPop=function(t){if(!hadPop){hadPop=!0;var a=e(t),o=(e(window).width()-a.outerWidth())/2,n=(e(window).height()-a.outerHeight())/2;n=(n<0?0:n)+e(window).scrollTop(),a.css({left:o,top:e(window).scrollTop(),opacity:0,display:"block"}).animate({left:o,top:n,opacity:1},500),e("#sg-overlay").css({width:e(document).width(),height:e(document).height()}).fadeIn(300)}},window.closePop=function(){hadPop=!1,e(".pop").hide(),e("#sg-overlay").fadeOut(300)},e("#sg-overlay").click(function(){closePop()}),e("#login-pop .login-form form").on("submit",function(t){t.preventDefault();var a=e("#form_username").val(),o=e("#form_passwd").val();""!=a?""!=o?e.post("/account/login",e(this).serialize(),function(t){t.ok?location.reload():e("#login-pop .login-form .error").text(t.error).show()}):e("#form_passwd").parent().addClass("has-error"):e("#form_username").parent().addClass("has-error")}),e("#username, #passwd").on("focus",function(){e("#login-pop .login-form .error").hide()});var t=function(t,a){if(1==e("#is_login_status").val()){var o=e(t).data("objid"),n=e(t).data("objtype"),r=parseInt(e(t).data("flag"),10);r=r?0:1,e.post("/like/"+o,{objtype:n,flag:r},function(o){if(o.ok){e(t).data("flag",r);var n=parseInt(e(t).children(".likenum").text(),10);r?(comTip("感谢赞！"),e(t).attr("title","取消赞").text("取消赞"),n++):(comTip("已取消赞！"),e(t).attr("title","赞").text("赞"),n--),e(t).children(".likenum").text(n),a(n,r)}else alert(o.error)})}else openPop("#login-pop")};e(".page #content-thank a").on("click",function(e){e.preventDefault();t(this,function(e,t){})}),e(".article .metatag .like").on("click",function(a){a.preventDefault();var o=this;t(o,function(t,a){a?e(o).children("i").removeClass("glyphicon-heart-empty").addClass("glyphicon-heart"):e(o).children("i").removeClass("glyphicon-heart").addClass("glyphicon-heart-empty")})});var a=function(t,a){if(1==e("#is_login_status").val()){var o=e(t).data("objid"),n=e(t).data("objtype"),r=parseInt(e(t).data("collect"),10);r=r?0:1,e.post("/favorite/"+o,{objtype:n,collect:r},function(e){e.ok?a(r):alert(e.error)})}else openPop("#login-pop")};e(".page .collect").on("click",function(t){t.preventDefault();a(this,function(t){e(".page .collect").data("collect",t),t?(comTip("感谢收藏！"),e(".page .collect").attr("title","取消收藏").text("取消收藏")):(e(".page .collect").attr("title","稍后再读").text("加入收藏"),comTip("已取消收藏！"))})}),e(".article .metatag .collect").on("click",function(t){t.preventDefault();var o=this;a(o,function(){e(o).parents("article").fadeOut()})}),window.saveComposeDraft=function(e,t,a){var o=t+":compose:by:"+e;lscache.set(o,a,525600),console.log("Compose draft for UID "+e+" is saved")},window.loadComposeDraft=function(e,t){var a=t+":compose:by:"+e,o=lscache.get(a);return console.log("Loaded compose draft for UID "+e),o},window.purgeComposeDraft=function(e,t){var a=t+":compose:by:"+e;lscache.remove(a),console.log("Purged compose draft for UID "+e)},window.saveReplyDraft=function(e,t,a,o){var n=t+":"+a+":reply:by:"+e;lscache.set(n,o,525600),console.log("Reply draft for "+t+":"+a+" is saved")},window.loadReplyDraft=function(e,t,a){var o=t+":"+a+":reply:by:"+e,n=lscache.get(o);return console.log("Loaded reply draft for "+t+":"+a),n},window.purgeReplyDraft=function(e,t,a){var o=t+":"+a+":reply:by:"+e;lscache.remove(o),console.log("Purged reply draft for "+t+":"+a)},setTimeout(function(){e(".page .content img").each(function(){e(this).hasClass("emoji")||e(this).addClass("img-responsive").attr("data-action","zoom")}),e(".page .content img").on("click",function(){e(this).parents(".box_white").css("overflow","visible")})},1e3),setTimeout(function(){e(".page .content table").addClass("table").wrap('<div class="table-responsive"></div>')},2e3)}),window.WebSocket=window.WebSocket||window.MozWebSocket,window.WebSocket){var websocket=new WebSocket(wsUrl);websocket.onopen=function(e){},websocket.onclose=function(e){},websocket.onmessage=function(e){switch(data=JSON.parse(e.data),data.type){case 0:var t=$("#user_message_count .badge"),a=parseInt(t.text(),10);totalVal=parseInt(data.body)+a,totalVal>0?t.addClass("badge-warning").text(totalVal):t.removeClass("badge-warning").text(0);break;case 1:$("#onlineusers").text(data.body.online),data.body.maxonline&&$("#maxonline").text(data.body.maxonline)}},websocket.onerror=function(e){}}var hadPop=!1;$(function(){$(window).scroll(function(){var e=parseFloat($(window).height())+parseFloat($(window).scrollTop());$(document).height()<=e&&$("#is_login_status").val(),$(".navbar").css("position",$(window).scrollTop()>0?"fixed":"relative"),$(window).scrollTop()>0?$("#wrapper").css("margin-top","52px"):$("#wrapper").css("margin-top","-20px")}),$("#login-pop .close").on("click",function(){closePop()})}),function(){jQuery(document).ready(function(e){e("form .md-toolbar .edit").on("click",function(t){t.preventDefault(),e(this).addClass("cur");var a=e(this).parents(".md-toolbar");a.find(".preview").removeClass("cur"),a.nextAll(".content-preview").hide(),a.next().show()}),e("form .md-toolbar .preview").on("click",function(t){t.preventDefault(),marked=SG.markSettingNoHightlight(),e(this).addClass("cur");var a=e(this).parents(".md-toolbar");a.find(".edit").removeClass("cur");var o=a.next();o.hide();var n=o.val(),r=a.nextAll(".content-preview");r.html(marked(n)),r.show()}),e("form .preview_btn").on("click",function(t){t.preventDefault(),marked=SG.markSettingNoHightlight();var a=e("form .md-toolbar");a.find(".preview").addClass("cur"),a.find(".edit").removeClass("cur");var o=a.next();o.hide();var n=o.val(),r=a.nextAll(".content-preview");r.html(marked(n)),r.show()})})}.call(this),window.initPLUpload=function(e){(e=e||{}).ele=e.ele||"upload-img",e.fileUploaded=e.fileUploaded||function(t,a){var o=$(e.ele).parents(".md-toolbar").next().children("textarea");0==o.length&&(o=$(".main-textarea"));var n=o.val();n+="!["+t.name+"]("+a.data.url+")",o.val(n)};var t=new plupload.Uploader({browse_button:e.ele,url:"/image/upload",filters:{mime_types:[{title:"图片文件",extensions:"jpg,gif,png,bmp"}],max_file_size:"5mb",prevent_duplicates:!0},multi_selection:!1,file_data_name:"img"});return t.init(),t.bind("FilesAdded",function(e,t){e.start()}),t.bind("UploadProgress",function(e,t){}),t.bind("FileUploaded",function(t,a,o){if(200==o.status){var n=$.parseJSON(o.response);n.ok?e.fileUploaded(a,n):comTip("上传失败："+n.error)}else comTip("上传失败：HTTP状态码："+o.status)}),t.bind("Error",function(e,t){comTip("上传出错了："+t.message)}),t},$(function(){initPLUpload()}),jQuery(document).ready(function(){$(".upload_img_single").Huploadify({auto:!0,fileTypeExts:"*.png;*.jpg;*.JPG;*.bmp;*.gif",multi:!1,fileSizeLimit:5242880,uploader:"/image/upload",buttonText:"上传",fileObjName:"img",showUploadedPercent:!0,onUploadSuccess:function(e,t){if((t=$.parseJSON(t)).ok){var a=t.data.url;$(".img_url").val(a),$("img.show_img").attr("src",a),$("a.show_img").attr("href",a)}else window.jAlert?jAlert(t.error,"错误"):alert(t.error)}})}),function(){window.Comment={},$(document).ready(function(){$(".page-comment #commentForm textarea").on("click",function(){1!=$("#is_login_status").val()&&openPop("#login-pop")}),$("#comment-content").on("change",function(){var e=$(this).val();saveReplyDraft(uid,keyprefix,objid,{content:e})}),function(){if("undefined"!=typeof keyprefix){var e=loadReplyDraft(uid,keyprefix,objid);e&&$("#comment-content").val(e.content)}}(),$(".page").on("click",".comment-edit-tab",function(e){e.preventDefault();var t=$(this),a=t.parent(),o=a.data("comment-group");t.addClass("cur"),a.children(".comment-preview-tab").removeClass("cur"),$('.comment-content-preview[data-comment-group="'+o+'"]').hide(),$('.comment-content-text[data-comment-group="'+o+'"]').show()}),$(".page").on("click",".comment-preview-tab",function(e){e.preventDefault();var t=SG.markSettingNoHightlight(),a=$(this).addClass("cur").parent(),o=a.data("comment-group"),n=$('.comment-content-preview[data-comment-group="'+o+'"]'),r=$('.comment-content-text[data-comment-group="'+o+'"]');a.children(".comment-edit-tab").removeClass("cur"),r.hide();var i=r.children("textarea").val();n.html(t(i)),emojify.run(n.get(0)),n.show(),Prism.highlightAll()}),$("#replies").on("mouseenter",".reply",function(e){$(this).find(".op-reply").removeClass("hideable")}),$("#replies").on("mouseleave",".reply",function(e){$(this).find(".op-reply").addClass("hideable")}),$("#replies").on("click",".reply_user",function(e){$(e.target).hasClass("reply_user")&&$(this).parents(".reply-to-block").find(".markdown").toggleClass("dn")});function e(e,t){var a=$('.markdown[data-floor="'+e+'"]'),o=a.children(".content"),n=a.children(".edit-wrapper");if(t)o.show(),n.hide();else{o.hide(),n.show();var r=n.children("textarea");r.val(r.data("raw-content")).focus()}}$("#replies").on("click",".btn-edit",function(t){t.preventDefault();var a=$(this).data("floor"),o=$('.markdown[data-floor="'+a+'"]').children(".edit-wrapper").children("textarea");e(a,!1);var n=$('.upload-img[data-floor="'+a+'"]'),r=o.data("paste-uploader");r||(r=o.pasteUploadImage("/image/paste_upload"),o.data("paste-uploader",r));var i=n.data("uploader");i||(i=window.initPLUpload({ele:n[0]}),n.data("uploader",i))}),$("#replies").on("click",".btn.cancel",function(t){t.stopPropagation();e($(this).data("floor"),!0)}),$("#replies").on("click",".btn.submit",function(o){o.stopPropagation();var n=$(this).data("floor"),r=$('.markdown[data-floor="'+n+'"]'),i=$(this),l=r.children(".edit-wrapper").find("textarea"),s=r.children(".content"),c=l.val(),d=i.data("cid");a(i,d,c,function(){l.data("raw-content",c),s.html(t(c)),e(n,!0)})}),$("#replies").on("click",".btn-reply",function(e){e.preventDefault();var t=$(this).data("floor"),a=$(this).data("username"),o=$(".md-toolbar .reply-to");o.data("floor",t).data("username",a);var n="回复#"+t+"楼";o.children(".fa-mail-reply").attr("title",n),o.children(".user").attr("title",n).attr("href","#reply"+t).text(a+" #"+t),o.removeClass("dn"),$("#commentForm textarea").focus()}),$(".md-toolbar .reply-to .close").on("click",function(e){e.preventDefault(),$(this).parents(".reply-to").addClass("dn").data("floor","").data("username","")}),$("#comment-content").pasteUploadImage("/image/paste_upload"),emojify.setConfig({only_crawl_id:null,img_dir:SG.EMOJI_DOMAIN,ignored_tags:{SCRIPT:1,TEXTAREA:1,A:1,PRE:1,CODE:1}}),window.loadComments=function(){var e={objid:$(".comment-list").data("objid"),objtype:$(".comment-list").data("objtype")};$.getJSON("/object/comments",e,function(e){if(e.ok){var a=(e=e.data).comments,o="";for(var n in a){var r=a[n],i=$('[name="me-uid"]').val(),l=e[r.uid],s=l.avatar;""==s?isHttps?l.avatar="https://secure.gravatar.com/avatar/"+md5(l.email)+"?s=48":l.avatar="http://gravatar.com/avatar/"+md5(l.email)+"?s=48":-1===s.indexOf("http")&&(l.avatar=cdnDomain+"avatar/"+s+"?imageView2/2/w/48");var c=SG.timeago(r.ctime);if(c==r.ctime){var d=c.split(" ");r.cmt_time=d[0]}else r.cmt_time=c;if(r.reply_floor>0){var m=a[r.reply_floor-1];r.reply_user=e[m.uid],r.reply_content=m.content}r.rawContent=r.content,r.content=t(r.content),o+=$.templates("#one-comment").render({comment:r,user:l,me:{uid:i}})}""!=o&&($(".comment-list .words").html(o),$(".comment-list .words .markdown").on("mousedown","a",function(e){$(this).attr("href");$(this).attr("target","_blank")}),$(".comment-list .markdown img").attr("data-action","zoom"),$(".comment-list .markdown img").on("click",function(){$(this).parents(".box_white").css("overflow","visible")})),$(".comment-list .words").removeClass("hide"),$(".comment-list .words").find('code[class*="language-"]').parent("pre").addClass("line-numbers"),Prism.highlightAll(),emojify.run($(".comment-list .words").get(0)),1==$("#is_login_status").val()&&SG.registerAtEvent(!0,!0,$(".page-comment textarea"))}else comTip("回复加载失败")})};var t=function(e){return e=SG.markSettingNoHightlight()(e=SG.preProcess(e)),SG.replaceCodeChar(e)};$("#comment-submit").on("click",function(){var e=$("#commentForm textarea").val();if(""==e)alert("其实你想说点什么...");else{var t=$(".md-toolbar .reply-to").data("floor");if(parseInt(t,10)>0){e="#"+t+"楼 @"+$(".md-toolbar .reply-to").data("username")+" "+e}o($(this),e,function(e){comTip("回复成功！"),purgeReplyDraft(uid,keyprefix,objid),$("#commentForm textarea").val(""),$(".md-toolbar .reply-to .close").click()})}});var a=function(e,t,a,o){e.text("稍等").addClass("disabled").attr({title:"稍等",disabled:"disabled"}),$.ajax({type:"post",url:"/object/comments/"+t,data:{content:a},dataType:"json",success:function(t){t.ok?(comTip("修改成功！"),o(),e.text("提交").removeClass("disabled").removeAttr("disabled").attr({title:"提交"})):alert(t.error)},error:function(){e.text("提交").removeClass("disabled").removeAttr("disabled").attr({title:"提交"})}})},o=function(e,a,o){e.text("稍等").addClass("disabled").attr({title:"稍等",disabled:"disabled"});var n=$(".comment-list").data("objid"),r=$(".comment-list").data("objtype"),i=SG.analyzeAt(a);$.ajax({type:"post",url:"/comment/"+n,data:{objtype:r,content:a,usernames:i.join(",")},dataType:"json",success:function(e){if(e.ok){var n=e.data,r=$(".comment-list"),i=$('[name="me-uid"]').val(),l={};l.username=r.data("username"),l.uid=r.data("uid"),l.avatar=r.data("avatar"),n.cmt_time=SG.timeago(n.ctime),n.reply_floor>0&&(n.content=a.substr(1)),n.reply_floor=0,n.rawContent=n.content,n.content=t(n.content);var s=$.templates("#one-comment").render({comment:n,user:l,is_new:!0,me:{uid:i}}),c=$("#replies .cmtnum"),d=parseInt(c.text(),10);0==d&&$(".comment-list .words").html(""),$(".comment-list .words").append(s).removeClass("hide"),Prism.highlightAll(),emojify.run($(".comment-list .words .reply:last").get(0)),SG.registerAtEvent(!0,!0,$(".page-comment textarea")),d++,c.text(d),setTimeout(function(){$(".comment-list .words .reply").removeClass("light")},2e3),o()}else alert(e.error)},complete:function(){e.text("提交").removeClass("disabled").removeAttr("disabled").attr({title:"提交"})},error:function(){e.text("提交").removeClass("disabled").removeAttr("disabled").attr({title:"提交"})}})}})}.call(this);